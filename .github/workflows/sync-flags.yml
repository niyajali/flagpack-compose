name: Sync Flags from Upstream

on:
  # Weekly sync on Sundays at midnight UTC
  schedule:
    - cron: '0 0 * * 0'

  # Allow manual trigger with custom ref
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to sync from (branch or tag)'
        required: false
        default: 'main'
        type: string
      dry_run:
        description: 'Check for new flags without syncing'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  check-new-flags:
    name: Check for New Flags
    runs-on: ubuntu-latest
    outputs:
      has_new_flags: ${{ steps.check.outputs.has_new_flags }}
      new_flags_count: ${{ steps.check.outputs.new_flags_count }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Cache Valkyrie CLI
        id: cache-valkyrie
        uses: actions/cache@v4
        with:
          path: valkyrie-cli
          key: valkyrie-cli-1.0.0

      - name: Setup Valkyrie CLI
        if: steps.cache-valkyrie.outputs.cache-hit != 'true'
        run: |
          VERSION="cli-1.0.0"
          LATEST_CLI_RELEASE_URL=$(curl --silent "https://api.github.com/repos/ComposeGears/Valkyrie/releases/tags/$VERSION" \
            | jq -r '.assets[] | select(.name | startswith("valkyrie-cli")) | .browser_download_url')
          curl -L -o valkyrie-cli.zip "$LATEST_CLI_RELEASE_URL"
          mkdir -p valkyrie-cli
          unzip -o valkyrie-cli.zip -d valkyrie-cli
          rm valkyrie-cli.zip
          chmod +x valkyrie-cli/bin/valkyrie

      - name: Add Valkyrie to PATH
        run: echo "${{ github.workspace }}/valkyrie-cli/bin" >> $GITHUB_PATH

      - name: Verify Valkyrie installation
        run: valkyrie --version

      - name: Check for new flags
        id: check
        run: |
          ./gradlew checkNewFlags \
            -PflagpackGitRef="${{ inputs.ref || 'main' }}"

      - name: Report check results
        run: |
          echo "### Flag Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- New flags available: ${{ steps.check.outputs.new_flags_count || '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Has new flags: ${{ steps.check.outputs.has_new_flags || 'false' }}" >> $GITHUB_STEP_SUMMARY

  sync-flags:
    name: Sync and Generate Flags
    runs-on: ubuntu-latest
    needs: check-new-flags
    if: ${{ !inputs.dry_run && (needs.check-new-flags.outputs.has_new_flags == 'true' || github.event_name == 'workflow_dispatch') }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Cache Valkyrie CLI
        id: cache-valkyrie
        uses: actions/cache@v4
        with:
          path: valkyrie-cli
          key: valkyrie-cli-1.0.0

      - name: Setup Valkyrie CLI
        if: steps.cache-valkyrie.outputs.cache-hit != 'true'
        run: |
          VERSION="cli-1.0.0"
          LATEST_CLI_RELEASE_URL=$(curl --silent "https://api.github.com/repos/ComposeGears/Valkyrie/releases/tags/$VERSION" \
            | jq -r '.assets[] | select(.name | startswith("valkyrie-cli")) | .browser_download_url')
          curl -L -o valkyrie-cli.zip "$LATEST_CLI_RELEASE_URL"
          mkdir -p valkyrie-cli
          unzip -o valkyrie-cli.zip -d valkyrie-cli
          rm valkyrie-cli.zip
          chmod +x valkyrie-cli/bin/valkyrie

      - name: Add Valkyrie to PATH
        run: echo "${{ github.workspace }}/valkyrie-cli/bin" >> $GITHUB_PATH

      - name: Verify Valkyrie installation
        run: valkyrie --version

      - name: Sync flags from upstream
        id: sync
        run: |
          ./gradlew syncAndGenerate \
            -PflagpackGitRef="${{ inputs.ref || 'main' }}"

      - name: Check for changes
        id: git_status
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.git_status.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: sync flags from flagpack-core'
          title: 'chore: sync flags from upstream flagpack-core'
          body: |
            ## Automated Flag Sync

            This PR was automatically created by the flag sync workflow.

            ### Changes
            - Synced new flags from [flagpack-core](https://github.com/Yummygum/flagpack-core)
            - Generated ImageVector Kotlin files
            - Updated flag list files

            ### Sync Details
            ${{ steps.sync.outputs.sync_details || 'See sync log for details.' }}

            ---

            **Source:** `${{ inputs.ref || 'main' }}`
            **New flags:** ${{ steps.sync.outputs.new_flags_count || 'See log' }}

            Please review the changes before merging.
          branch: chore/sync-flags-${{ github.run_number }}
          delete-branch: true
          labels: |
            automated
            flags
            sync

      - name: Report sync results
        run: |
          echo "### Sync Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ -f "flagpack-sync.log" ]]; then
            cat flagpack-sync.log >> $GITHUB_STEP_SUMMARY
          else
            echo "Sync completed. Check the PR for details." >> $GITHUB_STEP_SUMMARY
          fi
